<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘å­—å¹•æå–å·¥å…·</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common/loginButton.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common/displayWindow.css') }}">
    <script src="{{ url_for('static', filename='js/common/loginButton.js') }}"></script>
    
    <!-- è´§å¸æ˜¾ç¤ºæ ·å¼ -->
    <style>
        .balance-main {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .balance-secondary {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .currency-toggle {
            margin-top: 8px;
        }
        
        .toggle-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toggle-btn:hover {
            background: #e0e0e0;
            border-color: #ccc;
        }
        
        .toggle-btn:active {
            background: #d0d0d0;
        }
        /* å­—å¹•æå–é¡µé¢ç‰¹å®šæ ·å¼ */
        /* å­—å¹•æå–ä¸»è¦å†…å®¹åŒºåŸŸ - æ¨¡ä»¿ #history çš„æ ·å¼ */
        .subtitle-main {
            flex: 1;
            background: white;
            padding: 15px;
            overflow-y: auto;
            border-radius: 8px;
            margin-bottom: 0;
            min-height: 0;
            max-height: calc(100vh - 150px);
        }

        .subtitle-form-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .subtitle-form {
            width: 100%;
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin: 0;
        }

        /* å­—å¹•æå–æ“ä½œåŒºåŸŸ - æ¨¡ä»¿ input-section æ ·å¼ */
        .subtitle-controls {
            padding: 15px;
            background: white;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 8px 8px;
            flex-shrink: 0;
            max-height: 30vh;
            overflow-y: auto;
        }

        .process-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .subtitle-form h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .upload-area .upload-icon {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 10px;
        }

        .upload-area .upload-text {
            font-size: 1em;
            margin-bottom: 8px;
        }

        .upload-area .upload-hint {
            color: #999;
            margin-bottom: 10px;
            font-size: 0.8em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            font-weight: 600;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:disabled {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transform: none;
            box-shadow: none;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .options {
            margin: 15px 0;
            display: block;
        }

        .option-group {
            margin: 12px 0;
            text-align: left;
        }

        .option-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
            font-size: 0.95rem;
        }

        .option-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .option-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .result {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .result h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .result-info {
            margin: 10px 0;
            text-align: left;
        }

        .result-info strong {
            color: #667eea;
        }

        .download-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .download-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
        }

        .download-btn:hover::before {
            left: 100%;
        }

        .file-input {
            display: none;
        }

        /* ç¡®ä¿é¡µé¢åœ¨100%ç¼©æ”¾ä¸‹å®Œå…¨å¯è§ */
        @media screen and (max-height: 800px) {
            .subtitle-main {
                max-height: calc(100vh - 120px);
                padding: 12px;
            }
            
            .subtitle-controls {
                padding: 12px;
                max-height: 25vh;
            }
            
            .upload-area {
                padding: 15px;
            }
            
            .subtitle-form h1 {
                font-size: 1.6rem;
                margin-bottom: 12px;
            }
        }
        
        @media screen and (max-height: 700px) {
            .subtitle-main {
                max-height: calc(100vh - 100px);
                padding: 10px;
            }
            
            .subtitle-controls {
                padding: 10px;
                max-height: 20vh;
            }
            
            .upload-area {
                padding: 12px;
            }
            
            .subtitle-form h1 {
                font-size: 1.4rem;
                margin-bottom: 10px;
            }
            
            .upload-area .upload-icon {
                font-size: 2em;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .subtitle-main {
                padding: 12px;
                padding-bottom: calc(12px + env(safe-area-inset-bottom, 15px));
            }

            .subtitle-controls {
                padding: 12px;
                padding-bottom: calc(20px + env(safe-area-inset-bottom, 25px));
                margin-bottom: env(safe-area-inset-bottom, 8px);
            }
            
            .process-controls {
                margin-top: 15px;
                margin-bottom: 8px;
            }

            .subtitle-form {
                padding: 15px;
                max-width: 98%;
            }

            .subtitle-form h1 {
                font-size: 1.6rem;
                margin-bottom: 15px;
            }

            .upload-area {
                padding: 15px;
            }

            .upload-area .upload-icon {
                font-size: 2.2em;
            }

            .btn {
                padding: 12px 24px;
                font-size: 16px;
                min-height: 48px;
                width: auto;
                min-width: 150px;
            }
        }

        @media (max-width: 480px) {
            .subtitle-main {
                padding: 10px;
                padding-bottom: calc(15px + env(safe-area-inset-bottom, 20px));
            }
            
            .subtitle-controls {
                padding: 10px;
                padding-bottom: calc(25px + env(safe-area-inset-bottom, 30px));
                margin-bottom: env(safe-area-inset-bottom, 12px);
            }
            
            .process-controls {
                margin-top: 15px;
                margin-bottom: 10px;
            }

            .subtitle-form {
                padding: 12px;
                max-width: 100%;
            }

            .subtitle-form h1 {
                font-size: 1.4rem;
            }

            .upload-area {
                padding: 15px;
            }
            
            .btn {
                padding: 14px 28px;
                font-size: 16px;
                min-height: 50px;
                width: 100%;
                max-width: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- å·¦ä¾§èœå•æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Toolify AI</h2>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/chat" class="nav-item">
                    <div class="icon">ğŸ’¬</div>
                    <div class="text">AI å¯¹è¯</div>
                </a>
                <a href="/image" class="nav-item">
                    <div class="icon">ğŸ¨</div>
                    <div class="text">AI å›¾åƒç”Ÿæˆ</div>
                </a>
                <a href="/tts" class="nav-item">
                    <div class="icon">ğŸ”Š</div>
                    <div class="text">æ–‡å­—è½¬è¯­éŸ³</div>
                </a>
                <a href="/subtitle" class="nav-item active">
                    <div class="icon">ğŸ“</div>
                    <div class="text">å­—å¹•æå–</div>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <!-- ç™»å½•æŒ‰é’®ï¼ˆæœªç™»å½•æ—¶æ˜¾ç¤ºï¼‰ -->
                <button class="nav-item" id="sidebar-login-btn" style="display: none;" onclick="handleSidebarLogin()">
                    <div class="icon">ğŸ”‘</div>
                    <div class="text">ç™»å½•</div>
                </button>
                
                <!-- ç”¨æˆ·åï¼ˆå·²ç™»å½•æ—¶æ˜¾ç¤ºï¼‰ -->
                <div class="nav-item" id="sidebar-username" style="display: none;" onclick="toggleUserPopup()">
                    <div class="icon">ğŸ‘¤</div>
                    <div class="text" id="sidebar-username-text">{{ user_name }}</div>
                </div>
            </div>
        </div>
        
        <!-- ç§»åŠ¨ç«¯é®ç½©å±‚ -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
        
        <!-- ç§»åŠ¨ç«¯æµ®åŠ¨èœå•æŒ‰é’® -->
        <button class="mobile-menu-float" onclick="toggleSidebar()">â˜°</button>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- éšè—çš„é¡¶éƒ¨æ  - ä»…åœ¨ç§»åŠ¨ç«¯æœªç™»å½•æ—¶æ˜¾ç¤º -->
            <div class="top-bar" id="top-bar" style="display: none;">
                <div class="left-section">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        â˜°
                    </button>
                </div>
                
                <div class="right-section">
                    <!-- å³ä¸Šè§’ç™»å½•/æ³¨å†ŒæŒ‰é’®ï¼ˆç§»åŠ¨ç«¯æœªç™»å½•æ—¶æ˜¾ç¤ºï¼‰ -->
                    <div id="topbar-auth-buttons" style="display: none; gap: 10px;">
                        <button onclick="window.location.href='/loginPage?origin=' + encodeURIComponent(window.location.pathname)" 
                                style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            ç™»å½•
                        </button>
                        <button onclick="window.location.href='/register'" 
                                style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            æ³¨å†Œ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="chat-area">
                <div class="chat-container">
                    <!-- ç”¨æˆ·ä¿¡æ¯å¼¹çª— -->
                    <div id="popup">    
                        <div id="balance">
                            {% if balance_display %}
                                <div class="balance-main">ä½™é¢: {{ balance_display }}</div>
                                {% if balance_secondary %}
                                    <div class="balance-secondary">(çº¦{{ balance_secondary }})</div>
                                {% endif %}
                                <div class="currency-toggle">
                                    <button onclick="toggleCurrency()" class="toggle-btn">
                                        {% if currency_preference == 'CNY' %}åˆ‡æ¢åˆ°ç¾å…ƒæ˜¾ç¤º{% else %}åˆ‡æ¢åˆ°äººæ°‘å¸æ˜¾ç¤º{% endif %}
                                    </button>
                                </div>
                            {% else %}
                                <div class="balance-main">ä½™é¢: Â¥{{balance}}</div>
                            {% endif %}
                        </div>  
                        <div id="fund">
                            <form action="/orderPreCreate">
                                <button id="fund" type="submit" onclick="window.location.href='/payment_method?user_email={{ user_email }}&amount=10'; return false;">å……å€¼</button>
                            </form>
                        </div>        
                        <form action="/logout">
                            <button id="logoutButton" type="submit">ç™»å‡º</button>
                        </form>
                    </div>

                    <!-- å­—å¹•æå–ä¸»è¦å†…å®¹åŒºåŸŸ -->
                    <div class="subtitle-main">
                        <div class="subtitle-form-container">
                            <div class="subtitle-form">
                                <h1>ğŸ¬ è§†é¢‘å­—å¹•æå–å·¥å…·</h1>
                                <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">æ”¯æŒæå–å†…åµŒå­—å¹•ã€å¤–æŒ‚å­—å¹•ï¼Œæˆ–ä½¿ç”¨AIè¯­éŸ³è¯†åˆ«ç”Ÿæˆå­—å¹•</p>
                                
                                <!-- ç™»å½•æç¤ºåŒºåŸŸ -->
                                <div id="loginPrompt" style="display: none; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 12px; margin-bottom: 30px;">
                                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ”’</div>
                                    <h3 style="color: #333; margin-bottom: 15px;">éœ€è¦ç™»å½•</h3>
                                    <p style="color: #666; margin-bottom: 25px;">è¯·å…ˆç™»å½•åå†ä½¿ç”¨å­—å¹•æå–åŠŸèƒ½</p>
                                    <button class="btn" onclick="document.getElementById('loginButton').click()">ç«‹å³ç™»å½•</button>
                                </div>
                                
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-icon">ğŸ“</div>
                                    <div class="upload-text">ç‚¹å‡»æ­¤å¤„é€‰æ‹©æ–‡ä»¶ä¸Šä¼ </div>
                                    <div class="upload-hint">æ”¯æŒæ ¼å¼: MP4, AVI, MOV, MKV, WMV, FLV, WEBM, MP3, WAV, M4A, AAC, OGG, FLAC</div>
                                    <input type="file" id="fileInput" class="file-input" accept=".mp4,.avi,.mov,.mkv,.wmv,.flv,.webm,.mp3,.wav,.m4a,.aac,.ogg,.flac">
                                </div>

                                <div class="options" id="options">
                                    <div class="option-group">
                                        <label for="outputFormat">è¾“å‡ºæ ¼å¼:</label>
                                        <select id="outputFormat">
                                            <option value="srt">SRT æ ¼å¼</option>
                                            <option value="vtt">VTT æ ¼å¼</option>
                                        </select>
                                    </div>
                                    <div class="option-group">
                                        <label for="language">è¯†åˆ«è¯­è¨€:</label>
                                        <select id="language">
                                            <option value="zh">ä¸­æ–‡</option>
                                            <option value="en">è‹±æ–‡</option>
                                            <option value="ja">æ—¥æ–‡</option>
                                            <option value="ko">éŸ©æ–‡</option>
                                            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                                        </select>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                </div>
                    
                    <!-- å­—å¹•æå–æ“ä½œåŒºåŸŸ - æ¨¡ä»¿ input-section -->
                    <div class="subtitle-controls">
                        <div class="status" id="status"></div>

                <div class="result" id="result">
                    <h3>ğŸ‰ å¤„ç†å®Œæˆ!</h3>
                    <div id="resultInfo"></div>
                    <button class="btn download-btn" id="downloadBtn" onclick="downloadSubtitle()">ä¸‹è½½å­—å¹•æ–‡ä»¶</button>
                </div>
                        
                        <div class="process-controls">
                            <button class="btn" id="processBtn" onclick="processSubtitle()">å¼€å§‹å¤„ç†</button>
            </div>
        </div>
    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    <script>
        let uploadedFilePath = null;
        let downloadUrl = null;
        let useR2Storage = true;
        let downloadFilename = null;
        let isProcessingClick = false; // é˜²æ­¢é‡å¤ç‚¹å‡»

        // è´§å¸åˆ‡æ¢åŠŸèƒ½
        function toggleCurrency() {
            const currentCurrency = new URLSearchParams(window.location.search).get('currency') || 'CNY';
            const newCurrency = currentCurrency === 'CNY' ? 'USD' : 'CNY';
            
            // æ„å»ºæ–°çš„URL
            const url = new URL(window.location);
            url.searchParams.set('currency', newCurrency);
            
            // é‡æ–°åŠ è½½é¡µé¢
            window.location.href = url.toString();
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoadedäº‹ä»¶è§¦å‘');
            
            // ä½¿ç”¨æ ‡å‡†çš„ç™»å½•æŒ‰é’®å¤„ç†æµç¨‹
            try {
                loginButtonDisplayProcess();
            } catch (error) {
                console.error('loginButtonDisplayProcessé”™è¯¯:', error);
            }
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶æ˜¾ç¤ºç›¸åº”å†…å®¹
            try {
                checkLoginAndUpdateUI();
            } catch (error) {
                console.error('checkLoginAndUpdateUIé”™è¯¯:', error);
            }
            
            // è®¾ç½®ç™»å½•çŠ¶æ€ç›‘å¬
            try {
                setupLoginStateListener();
            } catch (error) {
                console.error('setupLoginStateListeneré”™è¯¯:', error);
            }
            
            // ç»‘å®šæ–‡ä»¶é€‰æ‹©äº‹ä»¶
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            

            
            // ä¸Šä¼ åŒºåŸŸç‚¹å‡»å¤„ç†
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('click', async function(e) {
                    // é˜²æ­¢é‡å¤ç‚¹å‡»
                    if (isProcessingClick) {
                        console.log('æ­£åœ¨å¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
                        return;
                    }
                    
                    isProcessingClick = true;
                    console.log('ä¸Šä¼ åŒºåŸŸè¢«ç‚¹å‡»');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    try {
                        const loginData = await checkLoginStatus();
                        if (!loginData.logged_in) {
                            showStatus('æœªç™»å½•ï¼Œè¯·ç™»å½•', 'error');
                        } else {
                            console.log('ç”¨æˆ·å·²ç™»å½•ï¼Œæ‰“å¼€æ–‡ä»¶é€‰æ‹©');
                            resetStateForNewFile();
                            if (fileInput) {
                                fileInput.click();
                                console.log('å·²è§¦å‘æ–‡ä»¶é€‰æ‹©');
                            } else {
                                console.error('fileInputå…ƒç´ ä¸å­˜åœ¨');
                                showStatus('æ–‡ä»¶é€‰æ‹©å™¨åˆå§‹åŒ–å¤±è´¥', 'error');
                            }
                        }
                    } catch (error) {
                        console.error('å¤„ç†ç‚¹å‡»äº‹ä»¶æ—¶å‡ºé”™:', error);
                        showStatus('ç³»ç»Ÿé”™è¯¯', 'error');
                    } finally {
                        // 500msåé‡ç½®ç‚¹å‡»çŠ¶æ€
                        setTimeout(() => {
                            isProcessingClick = false;
                        }, 500);
                    }
                });
            }
        });



        // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶æ›´æ–°UI
        async function checkLoginAndUpdateUI() {
            const dataCheckLogin = await checkLoginStatus();     
            let loginStatus = dataCheckLogin.logged_in;
            
            const loginPrompt = document.getElementById('loginPrompt');
            const uploadArea = document.getElementById('uploadArea');
            
            // å§‹ç»ˆéšè—ç™»å½•æç¤ºåŒºåŸŸï¼Œå§‹ç»ˆæ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
            // æœªç™»å½•ç”¨æˆ·å¯ä»¥çœ‹åˆ°ç•Œé¢ï¼Œä½†ç‚¹å‡»æ–‡ä»¶é€‰æ‹©æ—¶ä¼šæ˜¾ç¤ºç™»å½•æç¤º
            loginPrompt.style.display = 'none';
            uploadArea.style.display = 'block';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç™»å½•çŠ¶æ€
        window.addEventListener('load', function() {
            try {
                if (typeof displayLoginStatus === 'function') {
                    displayLoginStatus(); // ç¡®ä¿ç™»å½•çŠ¶æ€å’Œä½™é¢æ˜¾ç¤ºæ­£ç¡®
                } else {
                    console.warn('displayLoginStatuså‡½æ•°æœªå®šä¹‰');
                }
                checkLoginAndUpdateUI(); // æ›´æ–°å­—å¹•æå–é¡µé¢UI
            } catch (error) {
                console.error('é¡µé¢åŠ è½½åˆå§‹åŒ–é”™è¯¯:', error);
            }
        });

        // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
        function setupLoginStateListener() {
            // å®‰å…¨åœ°ç›‘å¬ç™»å½•æŒ‰é’®ç‚¹å‡»
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.addEventListener('click', function() {
                    setTimeout(function() {
                        if (typeof displayLoginStatus === 'function') {
                            displayLoginStatus(); // ä½¿ç”¨æ ‡å‡†çš„ç™»å½•çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
                        }
                        checkLoginAndUpdateUI(); // æ›´æ–°å­—å¹•æå–é¡µé¢UI
                    }, 1000); // å»¶è¿Ÿæ£€æŸ¥ï¼Œç­‰å¾…ç™»å½•å®Œæˆ
                });
            }
            
            // å®‰å…¨åœ°ç›‘å¬ç™»å‡ºæŒ‰é’®ç‚¹å‡»
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', function() {
                    setTimeout(function() {
                        if (typeof displayLoginStatus === 'function') {
                            displayLoginStatus(); // ä½¿ç”¨æ ‡å‡†çš„ç™»å½•çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
                        }
                        checkLoginAndUpdateUI(); // æ›´æ–°å­—å¹•æå–é¡µé¢UI
                    }, 500); // å»¶è¿Ÿæ£€æŸ¥ï¼Œç­‰å¾…ç™»å‡ºå®Œæˆ
                });
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥çœ‹åˆ°çŠ¶æ€å·²é‡ç½®
                e.target.value = '';
                handleFile(file);
            }
        }

        async function handleFile(file) {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const dataCheckLogin = await checkLoginStatus();     
            let loginStatus = dataCheckLogin.logged_in;
            
            if (loginStatus == false) {
                showStatus('è¯·å…ˆç™»å½•åå†ä½¿ç”¨å­—å¹•æå–åŠŸèƒ½', 'error');
                return;
            }

            // é‡ç½®ä¹‹å‰çš„çŠ¶æ€
            uploadedFilePath = null;
            downloadUrl = null;
            downloadFilename = null;
            document.getElementById('result').style.display = 'none';
            // ä¿æŒoptionså§‹ç»ˆæ˜¾ç¤º

            showStatus('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 'info');

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/subtitle/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'ä¸Šä¼ å¤±è´¥');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    uploadedFilePath = data.file_path;
                    useR2Storage = data.use_r2 || false;
                    showStatus(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${data.original_filename}`, 'success');
                    // é€‰é¡¹åŒºåŸŸå·²ç»é»˜è®¤æ˜¾ç¤ºï¼Œæ— éœ€å†æ¬¡è®¾ç½®
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                showStatus('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            });
        }

        async function processSubtitle() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const dataCheckLogin = await checkLoginStatus();     
            let loginStatus = dataCheckLogin.logged_in;
            
            if (loginStatus == false) {
                showStatus('è¯·å…ˆç™»å½•åå†ä½¿ç”¨å­—å¹•æå–åŠŸèƒ½', 'error');
                return;
            }

            if (!uploadedFilePath) {
                showStatus('è¯·å…ˆä¸Šä¼ æ–‡ä»¶', 'error');
                return;
            }

            const outputFormat = document.getElementById('outputFormat').value;
            const language = document.getElementById('language').value;

            showStatus('æ­£åœ¨å¤„ç†å­—å¹•ï¼Œè¯·ç¨å€™...', 'info');
            document.getElementById('processBtn').disabled = true;

            fetch('/api/subtitle/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_path: uploadedFilePath,
                    output_format: outputFormat,
                    language: language,
                    use_r2: useR2Storage
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'å¤„ç†å¤±è´¥');
                    });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('processBtn').disabled = false;
                
                if (data.success) {
                    downloadUrl = data.download_url;
                    downloadFilename = data.filename;
                    showResult(data);
                    showStatus('å­—å¹•å¤„ç†å®Œæˆï¼', 'success');
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                document.getElementById('processBtn').disabled = false;
                showStatus('å¤„ç†å¤±è´¥: ' + error.message, 'error');
            });
        }

        function showResult(data) {
            const resultDiv = document.getElementById('result');
            const resultInfo = document.getElementById('resultInfo');
            
            let infoHtml = `
                <div class="result-info"><strong>å¤„ç†ç±»å‹:</strong> ${getProcessingTypeText(data.processing_type)}</div>
                <div class="result-info"><strong>è¾“å‡ºæ ¼å¼:</strong> ${data.subtitle_format.toUpperCase()}</div>
                <div class="result-info"><strong>æ–‡ä»¶å:</strong> ${data.filename}</div>
                <div class="result-info"><strong>çŠ¶æ€:</strong> ${data.message}</div>
            `;
            
            resultInfo.innerHTML = infoHtml;
            resultDiv.style.display = 'block';
        }

        function getProcessingTypeText(type) {
            const types = {
                'embedded_subtitle': 'å†…åµŒå­—å¹•æå–',
                'external_subtitle': 'å¤–æŒ‚å­—å¹•è¯†åˆ«',
                'speech_recognition': 'AIè¯­éŸ³è¯†åˆ«'
            };
            return types[type] || type;
        }

        function downloadSubtitle() {
            if (downloadUrl) {
                const filename = downloadFilename || 'subtitle.srt';
                
                // å¦‚æœæ˜¯R2å­˜å‚¨çš„URLï¼Œä½¿ç”¨fetchä¸‹è½½
                if (downloadUrl.startsWith('http')) {
                    // R2é¢„ç­¾åURLï¼Œç›´æ¥è§¦å‘ä¸‹è½½
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = filename;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    // æœ¬åœ°æ–‡ä»¶ä¸‹è½½ï¼Œä½¿ç”¨fetch
                    fetch(downloadUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('ä¸‹è½½å¤±è´¥');
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                        })
                        .catch(error => {
                            console.error('ä¸‹è½½å¤±è´¥:', error);
                            showStatus('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
                        });
                }
            } else {
                showStatus('æ²¡æœ‰å¯ä¸‹è½½çš„å­—å¹•æ–‡ä»¶', 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            
            // å¦‚æœæ˜¯ä½™é¢ä¸è¶³çš„é”™è¯¯ï¼Œå°†å……å€¼é“¾æ¥è½¬æ¢ä¸ºå¯ç‚¹å‡»çš„é“¾æ¥
            if (type === 'error' && (message.includes('å……å€¼é“¾æ¥') || message.includes('è¯·å……å€¼'))) {
                let clickableMessage = message;
                if (message.includes('å……å€¼é“¾æ¥')) {
                    clickableMessage = message.replace('å……å€¼é“¾æ¥', `<a href="/payment_method?user_email={{ user_email }}&amount=10" style="color: #007bff; text-decoration: underline;">å……å€¼é“¾æ¥</a>`);
                } else if (message.includes('è¯·å……å€¼')) {
                    clickableMessage = message.replace('è¯·å……å€¼', `<a href="/payment_method?user_email={{ user_email }}&amount=10" style="color: #007bff; text-decoration: underline;">è¯·å……å€¼</a>`);
                }
                statusDiv.innerHTML = clickableMessage;
            } else {
                statusDiv.textContent = message;
            }
            
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        function resetStateForNewFile() {
            // é‡ç½®æ‰€æœ‰çŠ¶æ€å˜é‡
            uploadedFilePath = null;
            downloadUrl = null;
            downloadFilename = null;
            
            // éšè—ç»“æœåŒºåŸŸï¼Œä¿æŒé€‰é¡¹åŒºåŸŸæ˜¾ç¤º
            document.getElementById('result').style.display = 'none';
            // optionsä¿æŒæ˜¾ç¤ºï¼Œç”¨æˆ·å¯ä»¥é¢„å…ˆé€‰æ‹©æ ¼å¼å’Œè¯­è¨€
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            document.getElementById('fileInput').value = '';
            
            // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
            showStatus('è¯·é€‰æ‹©æ–°çš„è§†é¢‘æ–‡ä»¶', 'info');
        }

        // ç§»åŠ¨ç«¯ä¾§è¾¹æ æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }
        
        // ç”¨æˆ·å¼¹çª—æ§åˆ¶
        function toggleUserPopup() {
            const popup = document.getElementById('popup');
            if (popup) {
                popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        // å¤„ç†ä¾§è¾¹æ ç™»å½•æŒ‰é’®ç‚¹å‡»
        function handleSidebarLogin() {
            console.log('ä¾§è¾¹æ ç™»å½•æŒ‰é’®è¢«ç‚¹å‡»');
            window.location.href = '/loginPage?origin=' + encodeURIComponent(window.location.pathname);
        }
        
        // åˆå§‹åŒ–æ–°å¸ƒå±€çš„ç™»å½•åŠŸèƒ½
        async function initializeNewLayoutLogin() {
            console.log('åˆå§‹åŒ–æ–°å¸ƒå±€ç™»å½•åŠŸèƒ½');
            
            try {
                // é¦–å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€
                const loginData = await checkLoginStatus();
                const isLoggedIn = loginData.logged_in;
                
                // ä¾§è¾¹æ å…ƒç´ 
                const sidebarLoginBtn = document.getElementById('sidebar-login-btn');
                const sidebarUsername = document.getElementById('sidebar-username');
                const sidebarUsernameText = document.getElementById('sidebar-username-text');
                
                // é¡¶éƒ¨æ å…ƒç´ 
                const topbarAuthButtons = document.getElementById('topbar-auth-buttons');
                const topbarUserInfo = document.getElementById('topbar-user-info');
                const topbarWelcomeText = document.getElementById('topbar-welcome-text');
                
                if (isLoggedIn) {
                    console.log('ç”¨æˆ·å·²ç™»å½•');
                    
                    // éšè—ä¾§è¾¹æ ç™»å½•ï¼Œæ˜¾ç¤ºç”¨æˆ·å
                    if (sidebarLoginBtn) sidebarLoginBtn.style.display = 'none';
                    if (sidebarUsername) sidebarUsername.style.display = 'flex';
                    
                    // éšè—é¡¶éƒ¨æ ç™»å½•/æ³¨å†ŒæŒ‰é’®ï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                    if (topbarAuthButtons) topbarAuthButtons.style.display = 'none';
                    if (topbarUserInfo) topbarUserInfo.style.display = 'flex';
                    
                    // æ›´æ–°ç”¨æˆ·åæ˜¾ç¤º
                    if (loginData.user_name) {
                        if (sidebarUsernameText) {
                            sidebarUsernameText.textContent = loginData.user_name;
                        }
                        if (topbarWelcomeText) {
                            topbarWelcomeText.textContent = `æ¬¢è¿, ${loginData.user_name}!`;
                        }
                    }
                } else {
                    console.log('ç”¨æˆ·æœªç™»å½•');
                    
                    // éšè—ä¾§è¾¹æ ç™»å½•å’Œç”¨æˆ·å
                    if (sidebarLoginBtn) sidebarLoginBtn.style.display = 'none';
                    if (sidebarUsername) sidebarUsername.style.display = 'none';
                    
                    // æ˜¾ç¤ºé¡¶éƒ¨æ ç™»å½•/æ³¨å†ŒæŒ‰é’®ï¼Œéšè—ç”¨æˆ·ä¿¡æ¯
                    if (topbarAuthButtons) topbarAuthButtons.style.display = 'flex';
                    if (topbarUserInfo) topbarUserInfo.style.display = 'none';
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeNewLayoutLogin();
        });
    </script>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 