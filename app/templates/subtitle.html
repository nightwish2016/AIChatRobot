<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘å­—å¹•æå–å·¥å…·</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common/loginButton.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common/displayWindow.css') }}">
    <script src="{{ url_for('static', filename='js/common/loginButton.js') }}"></script>
    <style>
        /* å­—å¹•æå–é¡µé¢ç‰¹å®šæ ·å¼ */
        .subtitle-content {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow-y: auto;
        }

        .subtitle-form {
            width: 100%;
            max-width: 900px;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .subtitle-form h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.8rem;
            font-weight: 600;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 60px;
            text-align: center;
            margin-bottom: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .upload-area .upload-icon {
            font-size: 5em;
            color: #667eea;
            margin-bottom: 25px;
        }

        .upload-area .upload-text {
            font-size: 1.4em;
            margin-bottom: 20px;
        }

        .upload-area .upload-hint {
            color: #999;
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2em;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .options {
            margin: 20px 0;
            display: none;
        }

        .option-group {
            margin: 20px 0;
            text-align: left;
        }

        .option-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #555;
            font-size: 1.1rem;
        }

        .option-group select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .option-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .result {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .result h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .result-info {
            margin: 10px 0;
            text-align: left;
        }

        .result-info strong {
            color: #667eea;
        }

        .download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .file-input {
            display: none;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .subtitle-content {
                padding: 20px;
            }

            .subtitle-form {
                padding: 25px;
                max-width: 95%;
            }

            .subtitle-form h1 {
                font-size: 2.2rem;
                margin-bottom: 25px;
            }

            .upload-area {
                padding: 40px;
            }

            .upload-area .upload-icon {
                font-size: 4em;
            }

            .btn {
                padding: 12px 25px;
                font-size: 1.1em;
            }
        }

        @media (max-width: 480px) {
            .subtitle-content {
                padding: 15px;
            }

            .subtitle-form {
                padding: 20px;
                max-width: 98%;
            }

            .subtitle-form h1 {
                font-size: 1.8rem;
            }

            .upload-area {
                padding: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="upMenu">
            <div id="welcome"><p>æ¬¢è¿, {{ user_name }}!</p></div>
            <div class="otherUrl">
                <a href="/chat">AI èŠå¤©</a>
                <a href="/image">AI å›¾åƒç”Ÿæˆ</a>
                <a href="/tts">æ–‡å­—è½¬è¯­éŸ³</a>
            </div>
            <div class="login-section">
                <form id="login" action="/loginPage?origin=/subtitle" method="post">
                    <button id="loginButton">ç™»å½•</button>
                    <img id="loggedInIcon" src="{{ url_for('static', filename='image/login.png') }}" alt="å·²ç™»å½•"/> 
                </form>
            </div>
        </div>
        
        <!-- ç”¨æˆ·ä¿¡æ¯å¼¹çª— -->
        <div id="popup">    
            <div id="balance">ä½™é¢: Â¥{{balance}}</div>  
            <div id="fund">
                <form action="/orderPreCreate">
                    <button id="fund" type="submit">å……å€¼</button>
                </form>
            </div>        
            <form action="/logout">
                <button id="logoutButton" type="submit">ç™»å‡º</button>
            </form>
        </div>

        <!-- å­—å¹•æå–å†…å®¹åŒºåŸŸ -->
        <div class="subtitle-content">
            <div class="subtitle-form">
                <h1>ğŸ¬ è§†é¢‘å­—å¹•æå–å·¥å…·</h1>
                <p style="color: #666; margin-bottom: 30px;">æ”¯æŒæå–å†…åµŒå­—å¹•ã€å¤–æŒ‚å­—å¹•ï¼Œæˆ–ä½¿ç”¨AIè¯­éŸ³è¯†åˆ«ç”Ÿæˆå­—å¹•</p>
                
                <!-- ç™»å½•æç¤ºåŒºåŸŸ -->
                <div id="loginPrompt" style="display: none; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 12px; margin-bottom: 30px;">
                    <div style="font-size: 3em; margin-bottom: 20px;">ğŸ”’</div>
                    <h3 style="color: #333; margin-bottom: 15px;">éœ€è¦ç™»å½•</h3>
                    <p style="color: #666; margin-bottom: 25px;">è¯·å…ˆç™»å½•åå†ä½¿ç”¨å­—å¹•æå–åŠŸèƒ½</p>
                    <button class="btn" onclick="document.getElementById('loginButton').click()">ç«‹å³ç™»å½•</button>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                    <div class="upload-hint">æ”¯æŒæ ¼å¼: MP4, AVI, MOV, MKV, WMV, FLV, WEBM, MP3, WAV, M4A, AAC, OGG, FLAC</div>
                    <button class="btn" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
                    <input type="file" id="fileInput" class="file-input" accept=".mp4,.avi,.mov,.mkv,.wmv,.flv,.webm,.mp3,.wav,.m4a,.aac,.ogg,.flac">
                </div>

                <div class="status" id="status"></div>

                <div class="options" id="options">
                    <div class="option-group">
                        <label for="outputFormat">è¾“å‡ºæ ¼å¼:</label>
                        <select id="outputFormat">
                            <option value="srt">SRT æ ¼å¼</option>
                            <option value="vtt">VTT æ ¼å¼</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label for="language">è¯†åˆ«è¯­è¨€:</label>
                        <select id="language">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">è‹±æ–‡</option>
                            <option value="ja">æ—¥æ–‡</option>
                            <option value="ko">éŸ©æ–‡</option>
                            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                        </select>
                    </div>
                    <button class="btn" id="processBtn" onclick="processSubtitle()">å¼€å§‹å¤„ç†</button>
                </div>

                <div class="result" id="result">
                    <h3>ğŸ‰ å¤„ç†å®Œæˆ!</h3>
                    <div id="resultInfo"></div>
                    <button class="btn download-btn" id="downloadBtn" onclick="downloadSubtitle()">ä¸‹è½½å­—å¹•æ–‡ä»¶</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFilePath = null;
        let downloadUrl = null;

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // ä½¿ç”¨æ ‡å‡†çš„ç™»å½•æŒ‰é’®å¤„ç†æµç¨‹
            loginButtonDisplayProcess();
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶æ˜¾ç¤ºç›¸åº”å†…å®¹
            checkLoginAndUpdateUI();
            
            // è®¾ç½®ç™»å½•çŠ¶æ€ç›‘å¬
            setupLoginStateListener();
            
            // ç»‘å®šæ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // ç»‘å®šä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶ï¼ˆæ’é™¤æŒ‰é’®åŒºåŸŸï¼‰
            document.getElementById('uploadArea').addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘æ–‡ä»¶é€‰æ‹©
                if (e.target.id === 'selectFileBtn') {
                    return;
                }
                document.getElementById('fileInput').click();
            });
            
            // ç»‘å®šé€‰æ‹©æ–‡ä»¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('selectFileBtn').addEventListener('click', function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                document.getElementById('fileInput').click();
            });
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶æ›´æ–°UI
        async function checkLoginAndUpdateUI() {
            const dataCheckLogin = await checkLoginStatus();     
            let loginStatus = dataCheckLogin.logged_in;
            
            const loginPrompt = document.getElementById('loginPrompt');
            const uploadArea = document.getElementById('uploadArea');
            
            if (loginStatus == false) {
                // æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•æç¤ºï¼Œéšè—ä¸Šä¼ åŒºåŸŸ
                loginPrompt.style.display = 'block';
                uploadArea.style.display = 'none';
            } else {
                // å·²ç™»å½•ï¼šéšè—ç™»å½•æç¤ºï¼Œæ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
                loginPrompt.style.display = 'none';
                uploadArea.style.display = 'block';
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç™»å½•çŠ¶æ€
        window.addEventListener('load', function() {
            displayLoginStatus(); // ç¡®ä¿ç™»å½•çŠ¶æ€å’Œä½™é¢æ˜¾ç¤ºæ­£ç¡®
            checkLoginAndUpdateUI(); // æ›´æ–°å­—å¹•æå–é¡µé¢UI
        });

        // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
        function setupLoginStateListener() {
            // ç›‘å¬ç™»å½•æŒ‰é’®ç‚¹å‡»
            document.getElementById('loginButton').addEventListener('click', function() {
                setTimeout(function() {
                    displayLoginStatus(); // ä½¿ç”¨æ ‡å‡†çš„ç™»å½•çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
                    checkLoginAndUpdateUI(); // æ›´æ–°å­—å¹•æå–é¡µé¢UI
                }, 1000); // å»¶è¿Ÿæ£€æŸ¥ï¼Œç­‰å¾…ç™»å½•å®Œæˆ
            });
            
            // ç›‘å¬ç™»å‡ºæŒ‰é’®ç‚¹å‡»
            document.getElementById('logoutButton').addEventListener('click', function() {
                setTimeout(function() {
                    displayLoginStatus(); // ä½¿ç”¨æ ‡å‡†çš„ç™»å½•çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
                    checkLoginAndUpdateUI(); // æ›´æ–°å­—å¹•æå–é¡µé¢UI
                }, 500); // å»¶è¿Ÿæ£€æŸ¥ï¼Œç­‰å¾…ç™»å‡ºå®Œæˆ
            });
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        async function handleFile(file) {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const dataCheckLogin = await checkLoginStatus();     
            let loginStatus = dataCheckLogin.logged_in;
            
            if (loginStatus == false) {
                showStatus('è¯·å…ˆç™»å½•åå†ä½¿ç”¨å­—å¹•æå–åŠŸèƒ½', 'error');
                return;
            }

            showStatus('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 'info');

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/subtitle/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'ä¸Šä¼ å¤±è´¥');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    uploadedFilePath = data.file_path;
                    showStatus(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${data.original_filename}`, 'success');
                    document.getElementById('options').style.display = 'block';
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                showStatus('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            });
        }

        async function processSubtitle() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const dataCheckLogin = await checkLoginStatus();     
            let loginStatus = dataCheckLogin.logged_in;
            
            if (loginStatus == false) {
                showStatus('è¯·å…ˆç™»å½•åå†ä½¿ç”¨å­—å¹•æå–åŠŸèƒ½', 'error');
                return;
            }

            if (!uploadedFilePath) {
                showStatus('è¯·å…ˆä¸Šä¼ æ–‡ä»¶', 'error');
                return;
            }

            const outputFormat = document.getElementById('outputFormat').value;
            const language = document.getElementById('language').value;

            showStatus('æ­£åœ¨å¤„ç†å­—å¹•ï¼Œè¯·ç¨å€™...', 'info');
            document.getElementById('processBtn').disabled = true;

            fetch('/api/subtitle/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_path: uploadedFilePath,
                    output_format: outputFormat,
                    language: language
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'å¤„ç†å¤±è´¥');
                    });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('processBtn').disabled = false;
                
                if (data.success) {
                    downloadUrl = data.download_url;
                    showResult(data);
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                document.getElementById('processBtn').disabled = false;
                showStatus('å¤„ç†å¤±è´¥: ' + error.message, 'error');
            });
        }

        function showResult(data) {
            const resultDiv = document.getElementById('result');
            const resultInfo = document.getElementById('resultInfo');
            
            let infoHtml = `
                <div class="result-info"><strong>å¤„ç†ç±»å‹:</strong> ${getProcessingTypeText(data.processing_type)}</div>
                <div class="result-info"><strong>è¾“å‡ºæ ¼å¼:</strong> ${data.subtitle_format.toUpperCase()}</div>
                <div class="result-info"><strong>æ–‡ä»¶å:</strong> ${data.filename}</div>
                <div class="result-info"><strong>çŠ¶æ€:</strong> ${data.message}</div>
            `;
            
            resultInfo.innerHTML = infoHtml;
            resultDiv.style.display = 'block';
        }

        function getProcessingTypeText(type) {
            const types = {
                'embedded_subtitle': 'å†…åµŒå­—å¹•æå–',
                'external_subtitle': 'å¤–æŒ‚å­—å¹•è¯†åˆ«',
                'speech_recognition': 'AIè¯­éŸ³è¯†åˆ«'
            };
            return types[type] || type;
        }

        function downloadSubtitle() {
            if (downloadUrl) {
                window.open(downloadUrl, '_blank');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            
            // å¦‚æœæ˜¯ä½™é¢ä¸è¶³çš„é”™è¯¯ï¼Œå°†å……å€¼é“¾æ¥è½¬æ¢ä¸ºå¯ç‚¹å‡»çš„é“¾æ¥
            if (type === 'error' && (message.includes('å……å€¼é“¾æ¥') || message.includes('è¯·å……å€¼'))) {
                let clickableMessage = message;
                if (message.includes('å……å€¼é“¾æ¥')) {
                    clickableMessage = message.replace('å……å€¼é“¾æ¥', `<a href="/orderPreCreate" style="color: #007bff; text-decoration: underline;">å……å€¼é“¾æ¥</a>`);
                } else if (message.includes('è¯·å……å€¼')) {
                    clickableMessage = message.replace('è¯·å……å€¼', `<a href="/orderPreCreate" style="color: #007bff; text-decoration: underline;">è¯·å……å€¼</a>`);
                }
                statusDiv.innerHTML = clickableMessage;
            } else {
                statusDiv.textContent = message;
            }
            
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
    </script>
</body>
</html> 