<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频字幕提取工具</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common/loginButton.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common/displayWindow.css') }}">
    <script src="{{ url_for('static', filename='js/common/loginButton.js') }}"></script>
    
    <!-- 货币显示样式 -->
    <style>
        .balance-main {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .balance-secondary {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .currency-toggle {
            margin-top: 8px;
        }
        
        .toggle-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toggle-btn:hover {
            background: #e0e0e0;
            border-color: #ccc;
        }
        
        .toggle-btn:active {
            background: #d0d0d0;
        }
        
        /* 侧边栏汉堡菜单样式 */
        .sidebar-toggle-btn {
            position: relative;
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            padding: 0;
            border-radius: 6px;
            transition: background-color 0.15s ease;
        }
        
        .sidebar-toggle-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .hamburger-line {
            width: 18px;
            height: 2px;
            background: #5f6368;
            border-radius: 1px;
            transition: all 0.3s ease;
        }
        
        /* 收缩状态的侧边栏 */
        .sidebar.collapsed {
            width: 64px;
        }
        
        /* 收缩时隐藏所有菜单内容，只保留汉堡菜单 */
        .sidebar.collapsed .sidebar-nav,
        .sidebar.collapsed .sidebar-footer {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        /* 确保汉堡菜单在收缩时仍然可见和可点击 */
        .sidebar.collapsed .sidebar-toggle-btn {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        
        /* 动画过渡 */
        .sidebar {
            transition: width 0.3s ease;
        }
        
        .sidebar-nav,
        .sidebar-footer {
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        
        .sidebar-title {
            transition: opacity 0.2s ease;
        }
        
        .nav-item .text {
            transition: opacity 0.2s ease;
        }
        
        /* 统一顶部栏样式 - Gemini风格 */
        .unified-top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #ffffff;
            border-bottom: 1px solid #e8eaed;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: none;
        }
        
        .top-left, .top-center, .top-right {
            display: flex;
            align-items: center;
        }
        
        .top-left {
            flex: 0 0 auto;
            margin-right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* 顶部栏标题样式 - 科技感字体 */
        .topbar-title {
            font-size: 22px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', 'Consolas', 'Courier New', monospace;
            background: linear-gradient(135deg, #00d4ff 0%, #1a73e8 35%, #667eea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(26, 115, 232, 0.3);
            display: none; /* 默认隐藏，桌面端显示 */
            position: relative;
        }
        
        .topbar-title::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -8px;
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #00d4ff 0%, #1a73e8 100%);
            border-radius: 2px;
            transform: translateY(-50%);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
        }
        
        .top-right {
            flex: 0 0 auto;
            margin-left: 20px;
            gap: 12px;
        }
        
        /* 当侧边栏打开时隐藏整个统一顶部栏 */
        .unified-top-bar.hidden {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
        }
        
        /* 现代化科技感按钮样式 */
        .unified-top-bar .topbar-auth-btn {
            height: 38px;
            border-radius: 12px;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }
        
        /* 添加发光效果 */
        .unified-top-bar .topbar-auth-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.8s ease;
        }
        
        .unified-top-bar .topbar-auth-btn:hover::before {
            left: 100%;
        }
        
        .unified-top-bar .topbar-login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .unified-top-bar .topbar-login-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #5a72d8 0%, #6a4190 100%);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .unified-top-bar .topbar-login-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .unified-top-bar .topbar-register-btn {
            background: linear-gradient(135deg, #00d4ff 0%, #1a73e8 100%);
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
        }
        
        .unified-top-bar .topbar-register-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #00b8e6 0%, #1765cc 100%);
            box-shadow: 0 8px 25px rgba(26, 115, 232, 0.4);
        }
        
        .unified-top-bar .topbar-register-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);
        }
        
        /* 按钮内容高亮效果 */
        .unified-top-bar .topbar-auth-btn:hover {
            filter: brightness(1.1);
        }
        
        /* 主内容区域适配 - 为固定顶部栏留出空间 */
        .main-content {
            margin-top: 60px; /* 为统一顶部栏留出空间 */
        }
        
        /* 桌面端适配 - 侧边栏显示时 */
        @media (min-width: 769px) {
            .unified-top-bar {
                left: 280px; /* 给左侧菜单栏留出空间 */
                transition: left 0.3s ease;
            }
            
            .unified-top-bar.sidebar-collapsed {
                left: 64px; /* 收缩时调整顶部栏位置 */
            }
            
            .topbar-title {
                display: block; /* 桌面端显示标题 */
            }
            
            .mobile-hamburger-btn {
                display: none; /* 桌面端隐藏移动端汉堡菜单 */
            }
        }
        
        /* 移动端汉堡菜单按钮 */
        .mobile-hamburger-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            border-radius: 50%;
            display: none; /* 默认隐藏，只在移动端显示 */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #5f6368;
            transition: background-color 0.15s ease;
        }
        
        .mobile-hamburger-btn:hover {
            background: #f1f3f4;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .unified-top-bar {
                left: 0; /* 移动端占满全宽 */
                height: 56px;
                padding: 0 16px;
            }
            
            .main-content {
                margin-top: 56px; /* 调整移动端顶部间距 */
            }
            
            .top-left {
                margin-right: 12px;
            }
            
            .top-right {
                margin-left: 12px;
                gap: 8px;
            }
            
            /* 移动端显示汉堡菜单按钮 */
            .mobile-hamburger-btn {
                display: flex;
            }
            
            /* 移动端隐藏顶部栏标题 */
            .topbar-title {
                display: none;
            }
            
            /* 隐藏侧边栏的汉堡菜单按钮 */
            .sidebar-toggle-btn {
                display: none;
            }
            
            .unified-top-bar .topbar-auth-btn {
                height: 34px;
                padding: 6px 18px;
                font-size: 13px;
                border-radius: 10px;
                font-weight: 600;
            }
        }
        
        @media (max-width: 480px) {
            .unified-top-bar {
                left: 0; /* 小屏幕也占满全宽 */
                height: 56px; /* 增加高度以提供更好的视觉空间 */
                padding: 0 16px; /* 增加左右内边距 */
            }
            
            .main-content {
                margin-top: 56px; /* 调整小屏幕顶部间距 */
            }
            
            .top-left {
                margin-right: 12px; /* 增加右边距 */
                display: flex;
                align-items: center;
                gap: 12px;
            }
            
            .top-right {
                margin-left: 12px; /* 增加左边距 */
                gap: 10px; /* 增加按钮间距 */
                display: flex;
                align-items: center;
            }
            
            .mobile-hamburger-btn {
                width: 36px; /* 增加宽度 */
                height: 36px; /* 增加高度 */
                font-size: 16px;
                border-radius: 8px; /* 增加圆角 */
                background: rgba(60, 64, 67, 0.08);
                color: #5f6368;
                border: none;
                transition: all 0.15s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .mobile-hamburger-btn:hover {
                background: rgba(60, 64, 67, 0.12);
            }
            
            .unified-top-bar .topbar-auth-btn {
                height: 36px; /* 统一高度 */
                padding: 8px 18px; /* 增加内边距 */
                font-size: 13px; /* 增加字体大小 */
                border-radius: 18px;
                min-width: 70px; /* 设置最小宽度 */
                font-weight: 600;
                white-space: nowrap;
            }
        }
        /* 字幕提取页面特定样式 */
        /* 字幕提取主要内容区域 - 模仿 #history 的样式 */
        .subtitle-main {
            flex: 1;
            background: white;
            padding: 15px;
            overflow-y: auto;
            border-radius: 8px;
            margin-bottom: 0;
            min-height: 0;
            max-height: calc(100vh - 150px);
        }

        .subtitle-form-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .subtitle-form {
            width: 100%;
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin: 0;
        }

        /* 字幕提取操作区域 - 模仿 input-section 样式 */
        .subtitle-controls {
            padding: 15px;
            background: white;
            border-top: 1px solid #e5e7eb;
            border-radius: 0 0 8px 8px;
            flex-shrink: 0;
            max-height: 30vh;
            overflow-y: auto;
        }

        .process-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .subtitle-form h1 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .upload-area .upload-icon {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 10px;
        }

        .upload-area .upload-text {
            font-size: 1em;
            margin-bottom: 8px;
        }

        .upload-area .upload-hint {
            color: #999;
            margin-bottom: 10px;
            font-size: 0.8em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            font-weight: 600;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:disabled {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transform: none;
            box-shadow: none;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .options {
            margin: 15px 0;
            display: block;
        }

        .option-group {
            margin: 12px 0;
            text-align: left;
        }

        .option-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
            font-size: 0.95rem;
        }

        .option-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .option-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .result {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .result h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .result-info {
            margin: 10px 0;
            text-align: left;
        }

        .result-info strong {
            color: #667eea;
        }

        .download-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .download-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
        }

        .download-btn:hover::before {
            left: 100%;
        }

        .file-input {
            display: none;
        }

        /* 确保页面在100%缩放下完全可见 */
        @media screen and (max-height: 800px) {
            .subtitle-main {
                max-height: calc(100vh - 120px);
                padding: 12px;
            }
            
            .subtitle-controls {
                padding: 12px;
                max-height: 25vh;
            }
            
            .upload-area {
                padding: 15px;
            }
            
            .subtitle-form h1 {
                font-size: 1.6rem;
                margin-bottom: 12px;
            }
        }
        
        @media screen and (max-height: 700px) {
            .subtitle-main {
                max-height: calc(100vh - 100px);
                padding: 10px;
            }
            
            .subtitle-controls {
                padding: 10px;
                max-height: 20vh;
            }
            
            .upload-area {
                padding: 12px;
            }
            
            .subtitle-form h1 {
                font-size: 1.4rem;
                margin-bottom: 10px;
            }
            
            .upload-area .upload-icon {
                font-size: 2em;
            }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .subtitle-main {
                padding: 12px;
                padding-bottom: calc(12px + env(safe-area-inset-bottom, 15px));
            }

            .subtitle-controls {
                padding: 12px;
                padding-bottom: calc(20px + env(safe-area-inset-bottom, 25px));
                margin-bottom: env(safe-area-inset-bottom, 8px);
            }
            
            .process-controls {
                margin-top: 15px;
                margin-bottom: 8px;
            }

            .subtitle-form {
                padding: 15px;
                max-width: 98%;
            }

            .subtitle-form h1 {
                font-size: 1.6rem;
                margin-bottom: 15px;
            }

            .upload-area {
                padding: 15px;
            }

            .upload-area .upload-icon {
                font-size: 2.2em;
            }

            .btn {
                padding: 12px 24px;
                font-size: 16px;
                min-height: 48px;
                width: auto;
                min-width: 150px;
            }
        }

        @media (max-width: 480px) {
            .subtitle-main {
                padding: 10px;
                padding-bottom: calc(15px + env(safe-area-inset-bottom, 20px));
            }
            
            .subtitle-controls {
                padding: 10px;
                padding-bottom: calc(25px + env(safe-area-inset-bottom, 30px));
                margin-bottom: env(safe-area-inset-bottom, 12px);
            }
            
            .process-controls {
                margin-top: 15px;
                margin-bottom: 10px;
            }

            .subtitle-form {
                padding: 12px;
                max-width: 100%;
            }

            .subtitle-form h1 {
                font-size: 1.4rem;
            }

            .upload-area {
                padding: 15px;
            }
            
            .btn {
                padding: 14px 28px;
                font-size: 16px;
                min-height: 50px;
                width: 100%;
                max-width: 280px;
            }
        }
        
        /* 平板设备适配 */
        @media (max-width: 1024px) {
            /* 平板和移动端都隐藏注册按钮 */
            .topbar-register-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- 左侧菜单栏 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <!-- 汉堡菜单按钮 - 用于收缩/展开侧边栏 -->
                <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" onclick="toggleSidebarCollapse()">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/chat" class="nav-item">
                    <div class="icon">💬</div>
                    <div class="text">AI 对话</div>
                </a>
                <a href="/image" class="nav-item">
                    <div class="icon">🎨</div>
                    <div class="text">AI 图像生成</div>
                </a>
                <a href="/tts" class="nav-item">
                    <div class="icon">🔊</div>
                    <div class="text">文字转语音</div>
                </a>
                <a href="/subtitle" class="nav-item active">
                    <div class="icon">📝</div>
                    <div class="text">字幕提取</div>
                </a>
                <a href="/pricing" class="nav-item">
                    <div class="icon">💰</div>
                    <div class="text">价格方案</div>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <!-- 登录按钮（未登录时显示） -->
                <button class="nav-item" id="sidebar-login-btn" style="display: none;" onclick="handleSidebarLogin()">
                    <div class="icon">🔑</div>
                    <div class="text">登录</div>
                </button>
                
                <!-- 用户名（已登录时显示） -->
                <div class="nav-item" id="sidebar-username" style="display: none;" onclick="toggleUserPopup()">
                    <div class="icon">👤</div>
                    <div class="text" id="sidebar-username-text">{{ user_name }}</div>
                </div>
            </div>
        </div>
        
        <!-- 移动端遮罩层 -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
        
        <!-- 统一顶部栏 - 包含所有顶部元素 -->
        <div class="unified-top-bar" id="unified-top-bar">
            <!-- 左侧：Toolify AI 标题和移动端汉堡菜单 -->
            <div class="top-left">
                <button class="mobile-hamburger-btn" onclick="toggleSidebar()">☰</button>
                <h1 class="topbar-title">Toolify AI</h1>
            </div>
            
            <!-- 右侧：登录注册按钮 -->
            <div class="top-right">
                <!-- 右上角登录/注册按钮（未登录时显示） -->
                <div id="topbar-auth-buttons" style="display: none; gap: 10px;">
                    <button onclick="window.location.href='/loginPage?origin=' + encodeURIComponent(window.location.pathname)" 
                            class="topbar-auth-btn topbar-login-btn">
                        登录
                    </button>
                    <button onclick="window.location.href='/register'" 
                            class="topbar-auth-btn topbar-register-btn">
                        注册
                    </button>
                </div>
                
                <!-- 已登录时显示用户信息 -->
                <div id="topbar-user-info" style="display: none; align-items: center; gap: 10px;">
                    <span id="topbar-welcome-text" style="font-size: 14px; color: #555;">欢迎!</span>
                </div>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            
            <!-- 内容区域 -->
            <div class="chat-area">
                <div class="chat-container">
                    <!-- 用户信息弹窗 -->
                    <div id="popup">    
                        <div id="balance">
                            {% if balance_display %}
                                <div class="balance-main">余额: {{ balance_display }}</div>
                                {% if balance_secondary %}
                                    <div class="balance-secondary">(约{{ balance_secondary }})</div>
                                {% endif %}
                                <div class="currency-toggle">
                                    <button onclick="toggleCurrency()" class="toggle-btn">
                                        {% if currency_preference == 'CNY' %}切换到美元显示{% else %}切换到人民币显示{% endif %}
                                    </button>
                                </div>
                            {% else %}
                                <div class="balance-main">余额: ¥{{balance}}</div>
                            {% endif %}
                        </div>  
                        <div id="fund">
                            <form action="/orderPreCreate">
                                <button id="fund" type="submit" onclick="window.location.href='/payment_method?user_email={{ user_email }}&amount=10'; return false;">充值</button>
                            </form>
                        </div>        
                        <form action="/logout">
                            <button id="logoutButton" type="submit">登出</button>
                        </form>
                    </div>

                    <!-- 字幕提取主要内容区域 -->
                    <div class="subtitle-main">
                        <div class="subtitle-form-container">
                            <div class="subtitle-form">
                                <h1>🎬 视频字幕提取工具</h1>
                                <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">支持提取内嵌字幕、外挂字幕，或使用AI语音识别生成字幕</p>
                                
                                <!-- 登录提示区域 -->
                                <div id="loginPrompt" style="display: none; text-align: center; padding: 40px; background: #f8f9fa; border-radius: 12px; margin-bottom: 30px;">
                                    <div style="font-size: 3em; margin-bottom: 20px;">🔒</div>
                                    <h3 style="color: #333; margin-bottom: 15px;">需要登录</h3>
                                    <p style="color: #666; margin-bottom: 25px;">请先登录后再使用字幕提取功能</p>
                                    <button class="btn" onclick="document.getElementById('loginButton').click()">立即登录</button>
                                </div>
                                
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-icon">📁</div>
                                    <div class="upload-text">点击此处选择文件上传</div>
                                    <div class="upload-hint">支持格式: MP4, AVI, MOV, MKV, WMV, FLV, WEBM, MP3, WAV, M4A, AAC, OGG, FLAC</div>
                                    <input type="file" id="fileInput" class="file-input" accept=".mp4,.avi,.mov,.mkv,.wmv,.flv,.webm,.mp3,.wav,.m4a,.aac,.ogg,.flac">
                                </div>

                                <div class="options" id="options">
                                    <div class="option-group">
                                        <label for="outputFormat">输出格式:</label>
                                        <select id="outputFormat">
                                            <option value="srt">SRT 格式</option>
                                            <option value="vtt">VTT 格式</option>
                                        </select>
                                    </div>
                                    <div class="option-group">
                                        <label for="language">识别语言:</label>
                                        <select id="language">
                                            <option value="zh">中文</option>
                                            <option value="en">英文</option>
                                            <option value="ja">日文</option>
                                            <option value="ko">韩文</option>
                                            <option value="auto">自动检测</option>
                                        </select>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                </div>
                    
                    <!-- 字幕提取操作区域 - 模仿 input-section -->
                    <div class="subtitle-controls">
                        <div class="status" id="status"></div>

                <div class="result" id="result">
                    <h3>🎉 处理完成!</h3>
                    <div id="resultInfo"></div>
                    <button class="btn download-btn" id="downloadBtn" onclick="downloadSubtitle()">下载字幕文件</button>
                </div>
                        
                        <div class="process-controls">
                            <button class="btn" id="processBtn" onclick="processSubtitle()">开始处理</button>
            </div>
        </div>
    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

    <script>
        let uploadedFilePath = null;
        let downloadUrl = null;
        let useR2Storage = true;
        let downloadFilename = null;
        let isProcessingClick = false; // 防止重复点击

        // 货币切换功能
        function toggleCurrency() {
            const currentCurrency = new URLSearchParams(window.location.search).get('currency') || 'CNY';
            const newCurrency = currentCurrency === 'CNY' ? 'USD' : 'CNY';
            
            // 构建新的URL
            const url = new URL(window.location);
            url.searchParams.set('currency', newCurrency);
            
            // 重新加载页面
            window.location.href = url.toString();
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded事件触发');
            
            // 使用标准的登录按钮处理流程
            try {
                loginButtonDisplayProcess();
            } catch (error) {
                console.error('loginButtonDisplayProcess错误:', error);
            }
            
            // 检查登录状态并显示相应内容
            try {
                checkLoginAndUpdateUI();
            } catch (error) {
                console.error('checkLoginAndUpdateUI错误:', error);
            }
            
            // 设置登录状态监听
            try {
                setupLoginStateListener();
            } catch (error) {
                console.error('setupLoginStateListener错误:', error);
            }
            
            // 绑定文件选择事件
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            

            
            // 上传区域点击处理
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('click', async function(e) {
                    // 防止重复点击
                    if (isProcessingClick) {
                        console.log('正在处理点击事件，忽略重复点击');
                        return;
                    }
                    
                    isProcessingClick = true;
                    console.log('上传区域被点击');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    try {
                        const loginData = await checkLoginStatus();
                        if (!loginData.logged_in) {
                            showStatus('未登录，请登录', 'error');
                        } else {
                            console.log('用户已登录，打开文件选择');
                            resetStateForNewFile();
                            if (fileInput) {
                                fileInput.click();
                                console.log('已触发文件选择');
                            } else {
                                console.error('fileInput元素不存在');
                                showStatus('文件选择器初始化失败', 'error');
                            }
                        }
                    } catch (error) {
                        console.error('处理点击事件时出错:', error);
                        showStatus('系统错误', 'error');
                    } finally {
                        // 500ms后重置点击状态
                        setTimeout(() => {
                            isProcessingClick = false;
                        }, 500);
                    }
                });
            }
        });



        // 检查登录状态并更新UI
        async function checkLoginAndUpdateUI() {
            const dataCheckLogin = await checkLoginStatus();     
            let loginStatus = dataCheckLogin.logged_in;
            
            const loginPrompt = document.getElementById('loginPrompt');
            const uploadArea = document.getElementById('uploadArea');
            
            // 始终隐藏登录提示区域，始终显示上传区域
            // 未登录用户可以看到界面，但点击文件选择时会显示登录提示
            loginPrompt.style.display = 'none';
            uploadArea.style.display = 'block';
        }

        // 页面加载时初始化登录状态
        window.addEventListener('load', function() {
            try {
                if (typeof displayLoginStatus === 'function') {
                    displayLoginStatus(); // 确保登录状态和余额显示正确
                } else {
                    console.warn('displayLoginStatus函数未定义');
                }
                checkLoginAndUpdateUI(); // 更新字幕提取页面UI
            } catch (error) {
                console.error('页面加载初始化错误:', error);
            }
        });

        // 监听登录状态变化
        function setupLoginStateListener() {
            // 安全地监听登录按钮点击
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.addEventListener('click', function() {
                    setTimeout(function() {
                        if (typeof displayLoginStatus === 'function') {
                            displayLoginStatus(); // 使用标准的登录状态显示函数
                        }
                        checkLoginAndUpdateUI(); // 更新字幕提取页面UI
                    }, 1000); // 延迟检查，等待登录完成
                });
            }
            
            // 安全地监听登出按钮点击
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', function() {
                    setTimeout(function() {
                        if (typeof displayLoginStatus === 'function') {
                            displayLoginStatus(); // 使用标准的登录状态显示函数
                        }
                        checkLoginAndUpdateUI(); // 更新字幕提取页面UI
                    }, 500); // 延迟检查，等待登出完成
                });
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                // 清空文件输入，这样用户可以看到状态已重置
                e.target.value = '';
                handleFile(file);
            }
        }

        async function handleFile(file) {
            // 检查登录状态
            const dataCheckLogin = await checkLoginStatus();     
            let loginStatus = dataCheckLogin.logged_in;
            
            if (loginStatus == false) {
                showStatus('请先登录后再使用字幕提取功能', 'error');
                return;
            }

            // 重置之前的状态
            uploadedFilePath = null;
            downloadUrl = null;
            downloadFilename = null;
            document.getElementById('result').style.display = 'none';
            // 保持options始终显示

            showStatus('正在上传文件...', 'info');

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/subtitle/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || '上传失败');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    uploadedFilePath = data.file_path;
                    useR2Storage = data.use_r2 || false;
                    showStatus(`文件上传成功: ${data.original_filename}`, 'success');
                    // 选项区域已经默认显示，无需再次设置
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                showStatus('上传失败: ' + error.message, 'error');
            });
        }

        async function processSubtitle() {
            // 检查登录状态
            const dataCheckLogin = await checkLoginStatus();     
            let loginStatus = dataCheckLogin.logged_in;
            
            if (loginStatus == false) {
                showStatus('请先登录后再使用字幕提取功能', 'error');
                return;
            }

            if (!uploadedFilePath) {
                showStatus('请先上传文件', 'error');
                return;
            }

            const outputFormat = document.getElementById('outputFormat').value;
            const language = document.getElementById('language').value;

            showStatus('正在处理字幕，请稍候...', 'info');
            document.getElementById('processBtn').disabled = true;

            fetch('/api/subtitle/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_path: uploadedFilePath,
                    output_format: outputFormat,
                    language: language,
                    use_r2: useR2Storage
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || '处理失败');
                    });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('processBtn').disabled = false;
                
                if (data.success) {
                    downloadUrl = data.download_url;
                    downloadFilename = data.filename;
                    showResult(data);
                    showStatus('字幕处理完成！', 'success');
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                document.getElementById('processBtn').disabled = false;
                showStatus('处理失败: ' + error.message, 'error');
            });
        }

        function showResult(data) {
            const resultDiv = document.getElementById('result');
            const resultInfo = document.getElementById('resultInfo');
            
            let infoHtml = `
                <div class="result-info"><strong>处理类型:</strong> ${getProcessingTypeText(data.processing_type)}</div>
                <div class="result-info"><strong>输出格式:</strong> ${data.subtitle_format.toUpperCase()}</div>
                <div class="result-info"><strong>文件名:</strong> ${data.filename}</div>
                <div class="result-info"><strong>状态:</strong> ${data.message}</div>
            `;
            
            resultInfo.innerHTML = infoHtml;
            resultDiv.style.display = 'block';
        }

        function getProcessingTypeText(type) {
            const types = {
                'embedded_subtitle': '内嵌字幕提取',
                'external_subtitle': '外挂字幕识别',
                'speech_recognition': 'AI语音识别'
            };
            return types[type] || type;
        }

        function downloadSubtitle() {
            if (downloadUrl) {
                const filename = downloadFilename || 'subtitle.srt';
                
                // 如果是R2存储的URL，使用fetch下载
                if (downloadUrl.startsWith('http')) {
                    // R2预签名URL，直接触发下载
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = filename;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    // 本地文件下载，使用fetch
                    fetch(downloadUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('下载失败');
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                        })
                        .catch(error => {
                            console.error('下载失败:', error);
                            showStatus('下载失败: ' + error.message, 'error');
                        });
                }
            } else {
                showStatus('没有可下载的字幕文件', 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            
            // 如果是余额不足的错误，将充值链接转换为可点击的链接
            if (type === 'error' && (message.includes('充值链接') || message.includes('请充值'))) {
                let clickableMessage = message;
                if (message.includes('充值链接')) {
                    clickableMessage = message.replace('充值链接', `<a href="/payment_method?user_email={{ user_email }}&amount=10" style="color: #007bff; text-decoration: underline;">充值链接</a>`);
                } else if (message.includes('请充值')) {
                    clickableMessage = message.replace('请充值', `<a href="/payment_method?user_email={{ user_email }}&amount=10" style="color: #007bff; text-decoration: underline;">请充值</a>`);
                }
                statusDiv.innerHTML = clickableMessage;
            } else {
                statusDiv.textContent = message;
            }
            
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        function resetStateForNewFile() {
            // 重置所有状态变量
            uploadedFilePath = null;
            downloadUrl = null;
            downloadFilename = null;
            
            // 隐藏结果区域，保持选项区域显示
            document.getElementById('result').style.display = 'none';
            // options保持显示，用户可以预先选择格式和语言
            
            // 清空文件输入
            document.getElementById('fileInput').value = '';
            
            // 显示状态信息
            showStatus('请选择新的视频文件', 'info');
        }

        // 移动端侧边栏控制
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mobileMenuFloat = document.querySelector('.mobile-menu-float');
            
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                overlay.classList.add('show');
                // 隐藏汉堡菜单按钮
                if (mobileMenuFloat) {
                    mobileMenuFloat.classList.add('hidden');
                }
            } else {
                overlay.classList.remove('show');
                // 显示汉堡菜单按钮
                if (mobileMenuFloat) {
                    mobileMenuFloat.classList.remove('hidden');
                }
            }
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mobileMenuFloat = document.querySelector('.mobile-menu-float');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            // 显示汉堡菜单按钮
            if (mobileMenuFloat) {
                mobileMenuFloat.classList.remove('hidden');
            }
        }
        
        // 用户弹窗控制
        function toggleUserPopup() {
            const popup = document.getElementById('popup');
            if (popup) {
                const isVisible = popup.style.display === 'block';
                
                if (!isVisible) {
                    popup.style.display = 'block';
                    // 添加全局点击监听器
                    setTimeout(() => {
                        document.addEventListener('click', closePopupOnOutsideClick);
                    }, 0);
                } else {
                    popup.style.display = 'none';
                    // 移除全局点击监听器
                    document.removeEventListener('click', closePopupOnOutsideClick);
                }
            }
        }
        
        // 点击外部区域关闭弹窗
        function closePopupOnOutsideClick(event) {
            const popup = document.getElementById('popup');
            const sidebarUsername = document.getElementById('sidebar-username');
            
            if (popup && popup.style.display === 'block') {
                // 检查点击是否在弹窗内部或用户名按钮上
                const isInsidePopup = popup.contains(event.target);
                const isOnUsernameButton = sidebarUsername && sidebarUsername.contains(event.target);
                
                if (!isInsidePopup && !isOnUsernameButton) {
                    popup.style.display = 'none';
                    document.removeEventListener('click', closePopupOnOutsideClick);
                }
            }
        }
        
        // 处理侧边栏登录按钮点击
        function handleSidebarLogin() {
            console.log('侧边栏登录按钮被点击');
            window.location.href = '/loginPage?origin=' + encodeURIComponent(window.location.pathname);
        }
        
        // 检查登录状态的函数
        async function checkLoginStatus() {
            try {
                const response = await fetch('/check-login');
                const data = await response.json();           
                return data;
            } catch (error) {
                console.error("Error checking login status:", error);
                return { logged_in: false };
            }
        }
        
        // 初始化新布局的登录功能
        async function initializeNewLayoutLogin() {
            console.log('初始化新布局登录功能');
            
            try {
                // 首先检查登录状态
                const loginData = await checkLoginStatus();
                const isLoggedIn = loginData.logged_in;
                
                // 侧边栏元素
                const sidebarLoginBtn = document.getElementById('sidebar-login-btn');
                const sidebarUsername = document.getElementById('sidebar-username');
                const sidebarUsernameText = document.getElementById('sidebar-username-text');
                
                // 顶部栏元素
                const topBar = document.getElementById('top-bar');
                const topbarAuthButtons = document.getElementById('topbar-auth-buttons');
                const topbarUserInfo = document.getElementById('topbar-user-info');
                const topbarWelcomeText = document.getElementById('topbar-welcome-text');
                
                if (isLoggedIn) {
                    console.log('用户已登录');
                    
                    // 隐藏侧边栏登录，显示用户名
                    if (sidebarLoginBtn) sidebarLoginBtn.style.display = 'none';
                    if (sidebarUsername) sidebarUsername.style.display = 'flex';
                    
                    // 隐藏整个顶部栏
                    if (topBar) topBar.style.display = 'none';
                    
                    // 更新用户名显示
                    if (loginData.user_name) {
                        if (sidebarUsernameText) {
                            sidebarUsernameText.textContent = loginData.user_name;
                        }
                        if (topbarWelcomeText) {
                            topbarWelcomeText.textContent = `欢迎, ${loginData.user_name}!`;
                        }
                    }
                } else {
                    console.log('用户未登录');
                    
                    // 隐藏侧边栏登录和用户名
                    if (sidebarLoginBtn) sidebarLoginBtn.style.display = 'none';
                    if (sidebarUsername) sidebarUsername.style.display = 'none';
                    
                    // 显示顶部栏和登录/注册按钮
                    if (topBar) topBar.style.display = 'flex';
                    if (topbarAuthButtons) topbarAuthButtons.style.display = 'flex';
                    if (topbarUserInfo) topbarUserInfo.style.display = 'none';
                }
            } catch (error) {
                console.error('初始化登录状态失败:', error);
            }
        }
        
        // 侧边栏收缩/展开功能
        function toggleSidebarCollapse() {
            const sidebar = document.getElementById('sidebar');
            const topBar = document.querySelector('.unified-top-bar');
            
            sidebar.classList.toggle('collapsed');
            
            // 同时调整顶部栏位置
            if (sidebar.classList.contains('collapsed')) {
                topBar.classList.add('sidebar-collapsed');
            } else {
                topBar.classList.remove('sidebar-collapsed');
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeNewLayoutLogin();
        });
    </script>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 